<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.wlzq.activity.virtualfin.dao.ActFinOrderDao">
    <resultMap type="com.wlzq.activity.virtualfin.model.ActFinOrder" id="actFinOrderMap">
    	<result property="createTime" column="createTime" jdbcType="TIMESTAMP"/>
    	<result property="updateTime" column="updateTime" jdbcType="TIMESTAMP"/>
    </resultMap>
       
	<sql id="actFinOrderColumns">
		a.id AS "id",
		a.mobile AS "mobile",
		a.user_id AS "userId",
		a.open_id AS "openId",
		a.customer_id AS "customerId",
		a.flag AS "flag",
		a.activity_code AS "activityCode",
		a.product_code AS "productCode",
		a.goods_code AS "goodsCode",
		a.order_id AS "orderId",
		a.price AS "price",
		a.status AS "status",
		a.profit AS "profit",
		a.close_date_start AS "closeDateStart",
		a.close_date_end AS "closeDateEnd",
		a.create_time AS "createTime",
		a.update_time AS "updateTime",
		a.is_deleted AS "isDeleted"
	</sql>
	
	<sql id="actFinOrderJoins">
	</sql>
    
	<select id="get" resultType="ActFinOrder">
		SELECT 
			<include refid="actFinOrderColumns"/>
		FROM act_fin_order a
		<include refid="actFinOrderJoins"/>
		WHERE a.id = #{id}
	</select>
	
	<select id="findList" resultMap="actFinOrderMap">
		SELECT 
			<include refid="actFinOrderColumns"/>
			,b.name AS "activityName"
			,c.name AS "productName"
			,d.name AS "goodsName"
		FROM act_fin_order a
		LEFT JOIN act_activity b ON a.activity_code = b.code
		LEFT JOIN act_fin_product c ON a.product_code = c.code
		LEFT JOIN act_task_goods d ON a.goods_code = d.code
		<include refid="actFinOrderJoins"/>
		<where>
			c.ACTIVITY_CODE = a.ACTIVITY_CODE
			<if test="mobile != null and mobile != ''">
				AND a.mobile = #{mobile}
			</if>
			<if test="price != null">
				AND a.price = #{price}
			</if>
			<if test="status != null">
				AND a.status = #{status}
			</if>			
			<if test="now != null and status == 1">
				AND a.close_date_start <![CDATA[<=]]> #{now}
			</if>
			<if test="now != null and status == 2">
				AND a.close_date_end <![CDATA[<=]]> #{now}
			</if>
			<if test="activityCode != null and activityCode !=''">
				AND a.ACTIVITY_CODE = #{activityCode}
			</if>
		</where>
		ORDER BY a.id DESC
	</select>
	
	<select id="findAllList" resultType="ActFinOrder">
		SELECT 
			<include refid="actFinOrderColumns"/>
		FROM act_fin_order a
		<include refid="actFinOrderJoins"/>
		<where>
			
		</where>		
	</select>
    <select id="getLastAmountFlow" resultType="com.wlzq.activity.virtualfin.dto.LastAmountFlowResDto">
		select * from (
			  SELECT a."MOBILE" as mobile,a.PRICE as expAmount FROM act_fin_order a
			  where a.activity_code = #{activityCode}
			  order by a.id desc )
		where rownum &lt;=10
	</select>
    <select id="sumAmountByTimeAndActivityCode" resultType="java.math.BigDecimal">
		SELECT nvl(sum(a.PRICE), 0) FROM act_fin_order a
		<where>
			<if test="activityCode != null and activityCode != ''">
				AND a.activity_code = #{activityCode}
			</if>
			<if test="productCode != null and productCode != ''">
				AND a.product_code = #{productCode}
			</if>
			<if test="mobile != null and mobile != ''">
				AND a.mobile = #{mobile}
			</if>
			<if test="startTimeStr != null and startTimeStr != ''">
				AND a.CREATE_TIME >= to_date(#{startTimeStr},'yyyy-mm-dd hh24:mi:ss')
			</if>
			<if test="endTimeStr != null and endTimeStr != ''">
				AND a.CREATE_TIME &lt;= to_date(#{endTimeStr},'yyyy-mm-dd hh24:mi:ss')
			</if>
		</where>
	</select>

    <insert id="insert"  useGeneratedKeys="true" keyColumn="ID" keyProperty="id">
		INSERT INTO act_fin_order(
			mobile,
			user_id,
			open_id,
			customer_id,
			flag,
			activity_code,
			product_code,
			goods_code,
			order_id,
			price,
			status,
			profit,
			close_date_start,
			close_date_end,
			create_time
		) VALUES (
			#{mobile, jdbcType=VARCHAR},
			#{userId, jdbcType=VARCHAR},
			#{openId, jdbcType=VARCHAR},
			#{customerId, jdbcType=VARCHAR},
			#{flag, jdbcType=INTEGER},
			#{activityCode, jdbcType=VARCHAR},
			#{productCode, jdbcType=VARCHAR},
			#{goodsCode, jdbcType=VARCHAR},
			#{orderId, jdbcType=VARCHAR},
			#{price, jdbcType=DOUBLE},
			#{status, jdbcType=INTEGER},
			#{profit, jdbcType=DOUBLE},
			#{closeDateStart, jdbcType=TIMESTAMP},
			#{closeDateEnd, jdbcType=TIMESTAMP},
			#{createTime, jdbcType=TIMESTAMP}
		)
	</insert>
	
	<update id="update">
		UPDATE act_fin_order SET 	
			mobile = #{mobile, jdbcType=VARCHAR},
			user_id = #{userId, jdbcType=VARCHAR},
			open_id = #{openId, jdbcType=VARCHAR},
			customer_id = #{customerId, jdbcType=VARCHAR},
			flag = #{flag, jdbcType=INTEGER},
			activity_code = #{activityCode, jdbcType=VARCHAR},
			product_code = #{productCode, jdbcType=VARCHAR},
			goods_code = #{goodsCode, jdbcType=VARCHAR},
			order_id = #{orderId, jdbcType=VARCHAR},
			price = #{price, jdbcType=DOUBLE},
			status = #{status, jdbcType=INTEGER},
			profit = #{profit, jdbcType=DOUBLE},
			close_date_start = #{closeDateStart, jdbcType=TIMESTAMP},
			close_date_end = #{closeDateEnd, jdbcType=TIMESTAMP},
			update_time = #{updateTime, jdbcType=TIMESTAMP},
			is_deleted = #{isDeleted, jdbcType=INTEGER}
		WHERE id = #{id}
	</update>
	
	<update id="delete">
		DELETE FROM act_fin_order
		WHERE id = #{id}
	</update>
	
</mapper>