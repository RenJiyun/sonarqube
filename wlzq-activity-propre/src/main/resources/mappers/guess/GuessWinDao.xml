<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.wlzq.activity.guess.dao.GuesssWinDao">

	<sql id="guessWinColumns">
		a.id AS "id",
		a.activity_code AS "activityCode",
		a.user_id AS "userId",
		a.win_count AS "winCount",
		a.win_from_date AS "winFromDate",
		a.win_to_date AS "winToDate",
		a.win_dates AS "winDates",
		a.create_time AS "createTime",
		a.update_time AS "updateTime",
		a.remark AS "remark"
	</sql>

	<sql id="guessWinJoins">
	</sql>

	<select id="get" resultType="GuesssWin">
		SELECT
			<include refid="guessWinColumns"/>
		FROM act_guess_win a
		<include refid="guessWinJoins"/>
		WHERE a.id = #{id}
	</select>

	<select id="findLastWin" resultType="GuesssWin">
		select * from (
		SELECT
			<include refid="guessWinColumns"/>
		FROM act_guess_win a
		<include refid="guessWinJoins"/>
		WHERE a.user_id = #{userId}  AND a.activity_code = #{activityCode}
		 order by a.win_to_date desc
		) where rownum=1
	</select>

	<select id="findList" resultType="GuesssWin">
		SELECT
			<include refid="guessWinColumns"/>
		FROM act_guess_win a
		<include refid="guessWinJoins"/>
		<where>

			<if test="userId != null and userId != ''">
				AND a.user_id = #{userId}
			</if>
			<if test="winCount != null and winCount != ''">
				AND a.win_count = #{winCount}
			</if>
			<if test="winFromDate != null and winFromDate != ''">
				AND a.win_from_date = #{winFromDate}
			</if>
			<if test="winToDate != null and winToDate != ''">
				AND a.win_to_date = #{winToDate}
			</if>
		</where>
	</select>

	<select id="findAllList" resultType="GuesssWin">
		SELECT
			<include refid="guessWinColumns"/>
		FROM act_guess_win a
		<include refid="guessWinJoins"/>
		<where>

		</where>
	</select>


	<select id="rankingList" resultType="WinRanksDto">
		select *
		  from (select row_.*, rownum as "order"
		          from (select *
		                  from (select nvl(au.nick_name,REPLACE(au.mobile, substr(au.mobile,4,4), '****')) as "nickName",
		                               au.portrait as "portrait",
		                               nvl(b."win_count", 0) as "winCount",
		                               u.create_time as "registTime",
                                       au.mobile as "mobile"
		                          from (select a.user_id,
		                                           max(a.win_count) as "win_count"
		                                      from act_guess_win a
		                                    <where>
			                                    <if test="win.activityCode != null and win.activityCode != ''">
			                                       AND a.activity_code = #{win.activityCode}
			                                    </if>
			                                    <if test="win.winFromDate != null">
			                                       AND a.win_to_date >= #{win.winFromDate}
			                                    </if>
			                                    <if test="win.winToDate != null">
			                                       <![CDATA[ and a.win_to_date <= #{win.winToDate} ]]>
			                                    </if>
		                                    </where>
		                                     group by a.user_id) b
		                                     left join act_guess_user u on b.user_id = u.user_id
		                          left join acc_user au
		                            on b.user_id = au.user_id
		                            where  u.activity_code = #{win.activityCode})
		                 order by "winCount" desc,"registTime" asc) row_
		         WHERE <![CDATA[ rownum <= #{end} ]]>
		         )
		 WHERE "order" > #{start}
	</select>

	<select id="ranking" resultType="WinRanksDto">
		select *
	        from (select row_.*, rownum as "order"
	                from (select *
	                        from (select au.nick_name as "nickName",
	                                     au.portrait as "portrait",
	                                     b.user_id ,
	                                     nvl(b."win_count", 0) as "winCount",
	                                     u.create_time as "registTime"
	                                from (select a.user_id,
	                                                 max(a.win_count) as "win_count"
	                                            from act_guess_win a
	                                          where  activity_code = #{activityCode}
	                                           group by a.user_id) b
	                                           left join act_guess_user u on b.user_id = u.user_id
	                                left join acc_user au
	                                  on b.user_id = au.user_id
	                                where  u.activity_code = #{activityCode})
	                       order by "winCount" desc,"registTime" asc) row_
	               )
	       WHERE  user_id=#{userId}
	</select>

	<select id="rankingCount" resultType="java.lang.Long">
		select nvl(count(distinct(a.user_id)),0) from act_guess_win a where a.activity_code = #{activityCode}
	</select>

	<insert id="insert"  useGeneratedKeys="true" keyColumn="ID" keyProperty="id">
		INSERT INTO act_guess_win(
			activity_code,
			user_id,
			win_count,
			win_from_date,
			win_to_date,
			win_dates,
			create_time,
			remark
		) VALUES (
			#{activityCode},
			#{userId},
			#{winCount},
			#{winFromDate},
			#{winToDate},
			#{winDates},
			#{createTime},
			#{remark,jdbcType=VARCHAR}
		)
	</insert>

	<update id="update">
		UPDATE act_guess_win SET
			activity_code = #{activityCode},
			win_count = #{winCount},
			win_from_date = #{winFromDate},
			win_to_date = #{winToDate},
			win_dates = #{winDates},
			update_time = #{updateTime,jdbcType=TIMESTAMP},
			remark = #{remark,jdbcType=VARCHAR}
		WHERE id = #{id}
	</update>

	<update id="delete">
		DELETE FROM act_guess_win
		WHERE id = #{id}
	</update>

	<select id="allWinCount" resultType="java.lang.Long">
		select nvl(sum(a.win_count), 0)
		from act_guess_win a
		where a.user_id = #{userId} and a.activity_code = #{activityCode}
	</select>


	<select id="order" resultType="com.wlzq.activity.guess.dto.WinRanksDto">
		select o."order"
		from (select row_.*, row_number() over (order by win_count desc, create_time ) "order"
			  from (select b.user_id,
						   b.win_count,
						   u.create_time
					from (select a.user_id,
								 nvl(sum(a.win_count), 0) win_count
						  from act_guess_win a
						  where activity_code = #{activityCode}
						  group by a.user_id) b
							 left join act_guess_user u on b.user_id = u.user_id
					where u.activity_code = #{activityCode}) row_
			 ) o
		where o.USER_ID = #{userId}
	</select>

	<select id="count" resultType="java.lang.Long">
		select count(*)
		from (select count(*)
			  from act_guess_win a
			  where activity_code = #{activityCode}
			  group by a.user_id)
	</select>
</mapper>
